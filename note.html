<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Editor - BrainLog</title>
    <link rel="stylesheet" href="./style.css?v=7" />
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ§ </text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        /* FIX: Changed origin to bottom-right for natural "open left" feel */
        .popover-menu {
            transform-origin: bottom right;
            transition: transform 0.2s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.2s ease-out;
        }
        
        .popover-hidden {
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            pointer-events: none;
        }
        
        .popover-visible {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Specific override for center-aligned stats bubble */
        .popover-center {
            transform-origin: bottom center;
        }
        .popover-center.popover-hidden {
            transform: translateX(-50%) scale(0.95) translateY(10px);
        }
        .popover-center.popover-visible {
            transform: translateX(-50%) scale(1) translateY(0);
        }
    </style>

    <script>
        (function() {
            const saved = localStorage.getItem('brainlog_theme');
            const sys = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = (saved === 'system' || !saved) ? (sys ? 'dark' : 'light') : saved;
            document.documentElement.setAttribute('data-theme', theme);
        })();
    </script>
</head>
<body class="flex flex-col items-center justify-center h-[100dvh] overflow-hidden mode-paragraph bg-body text-main">

    <div class="w-full max-w-5xl flex flex-col h-full md:h-[90vh] md:my-6 editor-container relative">
        
        <div id="editor-wrapper" class="flex-grow overflow-y-auto px-6 md:px-32 md:pt-12 pb-48 relative">
            <div id="focus-overlay"></div>
            <div id="editable-area" 
                 class="max-w-2xl mx-auto"
                 contenteditable="true" 
                 data-placeholder="Start writing..." 
                 spellcheck="false">
            </div>
        </div>

        <div id="app-footer" 
             class="fixed bottom-0 left-0 w-full z-50 bg-card border-t border-border shadow-[0_-4px_20px_rgba(0,0,0,0.1)] flex justify-center items-start pt-3"
             style="padding-bottom: calc(2rem + env(safe-area-inset-bottom));">
            
            <div id="daily-progress-container" title="Daily Goal Progress" class="absolute top-0 left-0 w-full h-[2px]">
                <div id="daily-progress-bar"></div>
            </div>

            <div class="flex items-center gap-8 h-10 relative">
                
                <a id="back-btn" href="index.html" class="footer-btn p-2 rounded-full hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors h-10 w-10 flex items-center justify-center" title="Back to Notes">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-muted">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                    </svg>
                </a>

                <div class="flex items-center gap-2 h-10 relative">
                    <div id="save-indicator" class="mr-1"></div>
                    <span id="word-count" class="font-medium text-xs text-muted tabular-nums">0 words</span>
                    <button id="stats-info-btn" class="text-muted hover:text-main transition-colors p-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z" />
                        </svg>
                    </button>
                    
                    <div id="stats-popover" class="popover-hidden popover-center absolute bottom-full mb-4 left-1/2 -translate-x-1/2 bg-neutral-900 text-white dark:bg-neutral-100 dark:text-black px-4 py-2 rounded-lg shadow-xl text-xs z-50 whitespace-nowrap popover-menu">
                        <div id="sentence-count">0 sentences</div>
                        <div id="read-time" class="opacity-70 mt-1">0 min read</div>
                        <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-neutral-900 dark:bg-neutral-100 rotate-45"></div>
                    </div>
                </div>

                <div class="relative">
                    <button id="editor-menu-toggle" class="footer-btn p-2 rounded-full hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors h-10 w-10 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-muted">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                        </svg>
                    </button>

                    <div id="editor-menu" class="popover-hidden absolute bottom-full mb-4 right-0 w-48 bg-card border border-border rounded-xl shadow-2xl z-50 overflow-hidden popover-menu origin-bottom-right">
                        <div class="flex flex-col py-1">
                            <button id="toggle-mode-btn" class="text-left px-4 py-3 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-3 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-muted" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-muted"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                <span id="mode-text">Focus Mode</span>
                            </button>
                            <button id="download-markdown-btn" class="text-left px-4 py-3 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-3 border-t border-border transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                                <span>Download MD</span>
                            </button>
                            <button id="zen-mode-btn" class="text-left px-4 py-3 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-800 flex items-center gap-3 border-t border-border transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3.75v4.5m0-4.5h4.5m-4.5 0L9 9M3.75 20.25v-4.5m0 4.5h4.5m-4.5 0L9 15M20.25 3.75h-4.5m4.5 0v4.5m0-4.5L15 9m5.25 11.25h-4.5m4.5 0v-4.5m0 4.5L15 15" /></svg>
                                <span>Zen Mode</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './src/db.js';
        const body = document.body;
        const wrapper = document.getElementById('editor-wrapper');
        const editableArea = document.getElementById('editable-area');
        const overlay = document.getElementById('focus-overlay');
        
        // UI Elements
        const toggleBtn = document.getElementById('toggle-mode-btn');
        const modeText = document.getElementById('mode-text');
        const wordCountEl = document.getElementById('word-count');
        const sentenceCountEl = document.getElementById('sentence-count');
        const readTimeEl = document.getElementById('read-time');
        const saveIndicatorEl = document.getElementById('save-indicator');
        
        // Menus
        const menuToggle = document.getElementById('editor-menu-toggle');
        const editorMenu = document.getElementById('editor-menu');
        const statsBtn = document.getElementById('stats-info-btn');
        const statsPopover = document.getElementById('stats-popover');

        const STORAGE_KEY = 'elegant_writer_notes';
        const KEY_MODE = 'elegant_writer_mode';
        const STATS_KEY = 'brainlog_stats';
        
        let saveTimeout;
        let visualTimeout;
        const SAVE_DELAY = 1000;
        const PULSE_DURATION = 1200;

        const urlParams = new URLSearchParams(window.location.search);
        const NOTE_ID = urlParams.get('id');

        let currentMode = 'paragraph'; 
        let activeBlock = null;
        let isAutoScrolling = false;
        let scrollTimeout;

        let sessionStart = null;
        let lastKeyTime = null;
        let sessionKeys = 0;
        let startWordCount = 0;

        // --- MENU LOGIC ---
        function toggleElement(el) {
            if (el.classList.contains('popover-hidden')) {
                editorMenu.classList.add('popover-hidden'); editorMenu.classList.remove('popover-visible');
                statsPopover.classList.add('popover-hidden'); statsPopover.classList.remove('popover-visible');
                el.classList.remove('popover-hidden'); el.classList.add('popover-visible');
            } else {
                el.classList.add('popover-hidden'); el.classList.remove('popover-visible');
            }
        }

        menuToggle.addEventListener('click', (e) => { e.stopPropagation(); toggleElement(editorMenu); });
        statsBtn.addEventListener('click', (e) => { e.stopPropagation(); toggleElement(statsPopover); });

        document.addEventListener('click', (e) => {
            if (!editorMenu.contains(e.target)) { editorMenu.classList.add('popover-hidden'); editorMenu.classList.remove('popover-visible'); }
            if (!statsPopover.contains(e.target)) { statsPopover.classList.add('popover-hidden'); statsPopover.classList.remove('popover-visible'); }
        });

        // --- CORE FUNCTIONS ---
        function getNotes() { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }

        function initStats() {
            const text = editableArea.innerText || "";
            startWordCount = countWords(text);
            if (!localStorage.getItem(STATS_KEY)) { localStorage.setItem(STATS_KEY, JSON.stringify({ totalWords: 0, wpmAvg: 0, totalSessions: 0, daily: {} })); }
        }

        function countWords(str) { const matches = str.match(/\b\w+\b/g); return matches ? matches.length : 0; }

        function updateTracking() {
            const now = Date.now();
            if (!sessionStart || (now - lastKeyTime > 5000)) { sessionStart = now; sessionKeys = 0; }
            sessionKeys++; lastKeyTime = now;
            const currentText = editableArea.innerText || "";
            const currentCount = countWords(currentText);
            const delta = currentCount - startWordCount;
            if (delta !== 0) { saveWordStats(delta); startWordCount = currentCount; }
        }

        function saveWordStats(delta) {
            const stats = JSON.parse(localStorage.getItem(STATS_KEY));
            const today = new Date().toISOString().split('T')[0];
            if (!stats.daily[today]) stats.daily[today] = 0;
            stats.daily[today] += delta;
            stats.totalWords += delta;
            localStorage.setItem(STATS_KEY, JSON.stringify(stats));
        }

        function queueSave() { clearTimeout(saveTimeout); clearTimeout(visualTimeout); saveIndicatorEl.innerHTML = ''; saveTimeout = setTimeout(performSave, SAVE_DELAY); }

        function performSave() {
            if (!NOTE_ID) return;
            const notes = getNotes();
            const noteIndex = notes.findIndex(n => n.id === NOTE_ID);
            if (noteIndex > -1) {
                notes[noteIndex].content = editableArea.innerHTML;
                notes[noteIndex].updatedAt = Date.now();
                localStorage.setItem(STORAGE_KEY, JSON.stringify(notes));
                db.pushItem(notes[noteIndex]);
                db.updateProfile();
                renderStatus('saving');
                visualTimeout = setTimeout(() => { renderStatus('saved'); }, PULSE_DURATION);
            }
        }

        function renderStatus(state) {
            if (state === 'saving') { saveIndicatorEl.innerHTML = `<div class="status-saving"></div>`; } 
            else if (state === 'saved') { saveIndicatorEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`; }
        }

        function loadContent() {
            const savedMode = localStorage.getItem(KEY_MODE);
            if (savedMode) setMode(savedMode);
            if (NOTE_ID) {
                const notes = getNotes();
                const note = notes.find(n => n.id === NOTE_ID);
                if (note) {
                    editableArea.innerHTML = note.content; renderStatus('saved');
                    const backBtn = document.getElementById('back-btn');
                    if (backBtn && note.parentId) backBtn.href = `index.html?folder=${note.parentId}`;
                } else { editableArea.innerHTML = '<div><br></div>'; }
            } else { window.location.href = 'index.html'; }
            ensureStructure();
        }

        function setMode(mode) {
            currentMode = mode;
            if (mode === 'spotlight') { body.classList.replace('mode-paragraph', 'mode-spotlight'); modeText.textContent = 'Switch to Paragraph'; } 
            else { body.classList.replace('mode-spotlight', 'mode-paragraph'); modeText.textContent = 'Switch to Spotlight'; }
            localStorage.setItem(KEY_MODE, currentMode);
        }

        toggleBtn.addEventListener('click', () => { setMode(currentMode === 'spotlight' ? 'paragraph' : 'spotlight'); updateFocus(); forceCenter(); });

        function updateFocus() {
            const selection = window.getSelection(); if (!selection.rangeCount) return;
            let node = selection.anchorNode; while (node && node.parentNode !== editableArea) { node = node.parentNode; }
            if (currentMode === 'paragraph') {
                if (node && node.nodeName === 'DIV') { if (activeBlock !== node) { if (activeBlock) activeBlock.classList.remove('active-block'); node.classList.add('active-block'); activeBlock = node; } }
            }
            if (currentMode === 'spotlight') {
                const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect();
                let top = rect.top; let bottom = rect.bottom;
                if (rect.height === 0 && node) { const parentRect = node.getBoundingClientRect(); top = parentRect.top; bottom = parentRect.bottom; }
                const wrapperRect = wrapper.getBoundingClientRect();
                const relativeTop = top - wrapperRect.top + wrapper.scrollTop;
                const relativeBottom = bottom - wrapperRect.top + wrapper.scrollTop;
                overlay.style.setProperty('--focus-top', `${relativeTop - 8}px`); overlay.style.setProperty('--focus-bottom', `${relativeBottom + 8}px`);
            }
        }

        function syncOverlaySize() { if (currentMode === 'spotlight') overlay.style.height = `${editableArea.scrollHeight}px`; }

        function scrollEngine(instant = false) {
            const selection = window.getSelection(); if (!selection.rangeCount) return;
            let targetRect = null; const range = selection.getRangeAt(0); const rect = range.getBoundingClientRect();
            if (rect.top !== 0 || rect.bottom !== 0) targetRect = rect; else if (activeBlock) targetRect = activeBlock.getBoundingClientRect();
            if (!targetRect) return;
            const wrapperRect = wrapper.getBoundingClientRect();
            const relativeTop = targetRect.top - wrapperRect.top;
            const targetY = wrapperRect.height / 2;
            const offset = relativeTop - targetY + (targetRect.height / 2);
            if (Math.abs(offset) > 1) {
                isAutoScrolling = true; clearTimeout(scrollTimeout);
                if (instant) wrapper.scrollTop += offset; else wrapper.scrollTo({ top: wrapper.scrollTop + offset, behavior: 'smooth' }); 
                scrollTimeout = setTimeout(() => { isAutoScrolling = false; }, 500);
            }
        }

        function forceCenter() { scrollEngine(true); }

        wrapper.addEventListener('scroll', () => { if (!isAutoScrolling && !body.classList.contains('is-scrolling')) body.classList.add('is-scrolling'); }, { passive: true });
        editableArea.addEventListener('keydown', (e) => {
            if (body.classList.contains('is-scrolling')) body.classList.remove('is-scrolling');
            if (e.key === 'Enter') { setTimeout(() => { ensureStructure(); updateFocus(); scrollEngine(true); queueSave(); }, 0); }
        });

        const handleInput = (e) => { updateTracking(); ensureStructure(); syncOverlaySize(); updateFocus(); updateStats(); queueSave(); if (e.inputType !== 'insertParagraph') requestAnimationFrame(() => scrollEngine(false)); };
        const handleInteraction = () => { if (document.activeElement === editableArea) { updateFocus(); requestAnimationFrame(() => scrollEngine(false)); } };
        function ensureStructure() { if (!editableArea.firstChild || editableArea.innerHTML.trim() === '') editableArea.innerHTML = '<div><br></div>'; }

        function updateStats() {
            const text = editableArea.innerText || "";
            const words = text.match(/\b\w+\b/g); const wc = words ? words.length : 0;
            const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0); const sc = sentences.length;
            const readTime = Math.ceil(wc / 200);
            wordCountEl.textContent = `${wc} words`; sentenceCountEl.textContent = `${sc} sentences`; readTimeEl.textContent = `~${readTime} min read`;
            const dailyGoal = parseInt(localStorage.getItem('brainlog_daily_goal') || 0);
            const barContainer = document.getElementById('daily-progress-container'); const bar = document.getElementById('daily-progress-bar');
            if (dailyGoal > 0) {
                const stats = JSON.parse(localStorage.getItem(STATS_KEY) || '{"daily":{}}');
                const today = new Date().toISOString().split('T')[0];
                const dailyTotal = stats.daily[today] || 0;
                const percentage = Math.min((dailyTotal / dailyGoal) * 100, 100);
                bar.style.width = `${percentage}%`; barContainer.style.display = 'block';
                if (percentage >= 100) bar.className = 'goal-met'; else if (percentage > 0) bar.className = 'active'; else bar.className = '';
            } else { barContainer.style.display = 'none'; }
        }

        function setCursorToEnd() {
            const range = document.createRange(); const selection = window.getSelection();
            if(editableArea.lastChild) { range.selectNodeContents(editableArea); range.collapse(false); selection.removeAllRanges(); selection.addRange(range); }
        }

        const zenBtn = document.getElementById('zen-mode-btn');
        function toggleZenMode() {
            if (!document.fullscreenElement) { document.documentElement.requestFullscreen().catch(() => {}); body.classList.add('zen-mode'); document.documentElement.classList.add('zen-active'); } 
            else { if (document.exitFullscreen) document.exitFullscreen(); body.classList.remove('zen-mode'); document.documentElement.classList.remove('zen-active'); }
        }
        zenBtn.addEventListener('click', toggleZenMode);
        document.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement) { body.classList.remove('zen-mode'); } });

        editableArea.addEventListener('input', handleInput);
        document.addEventListener('selectionchange', handleInteraction);
        window.addEventListener('resize', () => { syncOverlaySize(); updateFocus(); forceCenter(); });
        editableArea.addEventListener('paste', (e) => { e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text/plain'); document.execCommand('insertText', false, text); handleInput({ inputType: 'insertText' }); });

        document.getElementById('download-markdown-btn').addEventListener('click', () => {
            let markdown = ""; const lines = editableArea.querySelectorAll('div');
            lines.forEach((line, index) => { let text = line.innerText.replace(/\n/g, ''); if (index === 0 && text.trim().length > 0) markdown += `# ${text}\n\n`; else { markdown += text; if (index < lines.length - 1) markdown += "\n\n"; } });
            const firstLine = lines[0]?.innerText.trim() || 'Untitled';
            const safeName = firstLine.replace(/[^a-z0-9]/gi, '-').toLowerCase().substring(0, 30);
            const fileName = safeName.length > 0 ? `${safeName}.md` : `note-${Date.now()}.md`;
            const blob = new Blob([markdown], { type: 'text/markdown;charset=utf-8' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = fileName; a.click(); URL.revokeObjectURL(url);
        });

        window.addEventListener('DOMContentLoaded', () => {
            loadContent(); ensureStructure(); setCursorToEnd(); editableArea.focus(); 
            updateStats(); syncOverlaySize(); updateFocus(); initStats();
            let attempts = 0;
            const centerInterval = setInterval(() => { forceCenter(); attempts++; if (attempts > 5) { clearInterval(centerInterval); wrapper.classList.add('ready'); } }, 20);
        });

        let zenMouseTimeout;
        document.addEventListener('mousemove', () => {
            if (!body.classList.contains('zen-mode')) return;
            body.classList.add('zen-ui-visible'); clearTimeout(zenMouseTimeout);
            zenMouseTimeout = setTimeout(() => { body.classList.remove('zen-ui-visible'); }, 2000);
        });
    </script>
</body>
</html>